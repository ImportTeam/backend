generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum PaymentType {
  CARD
  PAYPAL
  APPLEPAY
  KAKAOPAY
  NAVERPAY
  ETC
}

enum DiscountType {
  PERCENT
  FLAT
}

model users {
  seq                    BigInt    @id @default(autoincrement())
  uuid                   String    @unique
  email                  String?   @unique
  password_hash          String?
  social_provider        String    @default("NONE")
  social_id              String?
  name                   String
  preferred_payment_seq  BigInt?
  created_at             DateTime  @default(now())
  updated_at             DateTime  @updatedAt

  payment_methods  payment_methods[]
  user_sessions    user_sessions[]
  user_settings    user_settings?
  payment_transactions payment_transactions[]
}

model payment_methods {
  seq                BigInt      @id @default(autoincrement())
  user_uuid          String
  type               PaymentType
  
  // 카드 기본 정보
  card_number_hash   String?     @db.VarChar(255)  // 암호화된 전체 카드번호 (복호화 가능)
  last_4_nums        String      @db.Char(4)       // 카드번호 뒷자리 (표시용)
  card_holder_name   String?     @db.VarChar(100)  // 카드 소유자 이름
  
  // 카드사 정보
  provider_name      String      @db.VarChar(50)   // 카드사명 (신한, 삼성, 비자 등)
  card_brand         String?     @db.VarChar(20)   // 카드 브랜드 (VISA, MASTER, AMEX 등)
  
  // 만료일 정보
  expiry_month       String?     @db.Char(2)       // 만료 월 (01-12)
  expiry_year        String?     @db.Char(4)       // 만료 년도 (YYYY)
  
  // CVC/CVV (암호화 저장)
  cvv_hash           String?     @db.VarChar(255)  // 암호화된 CVV/CVC
  
  // 청구지 정보
  billing_address    String?     @db.VarChar(255)  // 청구지 주소
  billing_zip        String?     @db.VarChar(20)   // 청구지 우편번호
  
  // 부가 정보
  alias              String?     @db.VarChar(50)   // 사용자 지정 별칭
  is_primary         Boolean     @default(false)   // 주 결제수단 여부
  
  created_at         DateTime    @default(now())
  updated_at         DateTime    @updatedAt

  user users @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)

  @@index([user_uuid])
  @@index([expiry_year, expiry_month])
}

model user_sessions {
  seq            BigInt   @id @default(autoincrement())
  user_seq       BigInt
  access_token   String   @db.VarChar(500)
  refresh_token  String   @db.VarChar(500)
  expires_at     DateTime
  device_info    String?  @db.VarChar(255)
  created_at     DateTime @default(now())

  user users @relation(fields: [user_seq], references: [seq], onDelete: Cascade)

  @@index([user_seq])
  @@index([expires_at])
}

model user_settings {
  user_seq             BigInt   @id
  dark_mode            Boolean  @default(false)
  notification_enabled Boolean  @default(true)
  compare_mode         String   @default("AUTO")
  currency_preference  String   @default("KRW")
  updated_at           DateTime @updatedAt

  user users @relation(fields: [user_seq], references: [seq], onDelete: Cascade)
}

// 사용자의 결제 내역 저장
model payment_transactions {
  seq                 BigInt   @id @default(autoincrement())
  user_uuid           String
  payment_method_seq  BigInt?
  merchant_name       String    @db.VarChar(255)
  amount              Decimal   @db.Decimal(19, 2)
  currency            String    @default("KRW")
  benefit_value       Decimal?  @db.Decimal(19, 2)
  benefit_desc        String?   @db.VarChar(255)
  compared_at         DateTime?
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  user users @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)

  @@index([user_uuid, created_at])
  @@index([payment_method_seq])
}

// 카드/페이 혜택/프로모션 정보 저장 (크롤링/수동 입력)
model benefit_offers {
  id              BigInt       @id @default(autoincrement())
  provider_name   String       @db.VarChar(50) // 카드사명 또는 페이명 (신한, 삼성, KAKAOPAY 등)
  payment_type    PaymentType?
  title           String       @db.VarChar(255)
  description     String?      @db.Text
  merchant_filter String?      @db.VarChar(255) // 포함 매칭(단순 문자열)
  category_filter String?      @db.VarChar(100)
  min_spend       Decimal?     @db.Decimal(19, 2)
  discount_type   DiscountType
  discount_value  Decimal      @db.Decimal(19, 2)
  max_discount    Decimal?     @db.Decimal(19, 2)
  start_date      DateTime?
  end_date        DateTime?
  active          Boolean      @default(true)
  source_url      String?      @db.VarChar(255)
  hash            String?      @unique @db.VarChar(64)
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt

  @@index([provider_name])
  @@index([active, end_date])
}
